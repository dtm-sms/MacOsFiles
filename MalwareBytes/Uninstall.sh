#!/bin/bash
#Script to Uninstall MalwareBytes if Falcon Sensor is already installed
#Use uninstall_reinstall.tool provided by MalwareBytes

LoggedinUser=$(id -un)
scriptname="Unistall-MalwareBytes"
alticedir="/Library/Altice/"
appsdir="/Library/Altice/Apps/"
commondir="/Library/Altice/Common/"
logdir="/Library/Altice/IntuneDTMLogs/"
logfile="Unistall-MalwareBytes.log"
logpath=$logdir/$logfile
uninstall_files="https://github.com/dtm-sms/MacOsFiles/blob/main/MalwareBytes/dockutil"
                 
logdirflag=1

function preparelog
{
    alticedirflag=1
    if [ ! -d "$alticedir" ]; then
        mkdir $alticedir
        alticedirflag=0
    fi
 
    if [ ! -d "$logdir" ]; then
        mkdir $logdir
        logdirflag=0
    fi
 
    echo  [$(date +"%d/%m/%Y %T")] - Begin $scriptname > $logpath
    if [ $alticedirflag -eq 0 ]; then
        Dolog "$alticedir does not exist and was created"
    fi
 
    if [ $logdirflag -eq 0 ]; then
        Dolog "$logdir does not exist and was created"
    fi
 
    if [ ! -d "$appsdir" ]; then
        mkdir $appsdir
        Dolog "$appsdir does not exist and was created"
    fi
 
    if [ ! -d "$commondir" ]; then
        mkdir $commondir
        Dolog "$commondir does not exist and was created"
    fi
 
}

function Dolog
{
    printf "[$(date +"%d/%m/%Y %T")] - $1\n" >> $logpath
}

function ExitWithRc
{
  Dolog "Script ended with Error Code $1"
  exit $1
}

function Check_falcon_app
{
    falcon_app="/Applications/Falcon.app/Contents/Resources/falconctl"
    validation_file="/Library/Application Support/CrowdStrike/Falcon/License.bin"

  Dolog "Check if Falcon Software is installed"
  if [ ! -f "$falcon_app" ]; then
    Dolog "Falcon Software not installed yet"
    ExitWithRc 9
  else
    Dolog "Falcon Software is installed!"
    if [ ! -f "$validation_file" ]; then
      Dolog "Falcon Software is not activated yet... activating"
      ExitWithRc 10
    else
      Dolog "Falcon Software is already activated"
        go_uninstall_malwarebytes
    fi
  fi
}

function go_uninstall_malwarebytes
{
    tmpdir="/tmp/"
    #osascript /tmp/m/main.scp
    #WallpaperFileURL="https://github.com/alourinho74/MacStuff/blob/main/Wallpapers/Img/$fich"
    MalwareBytes/uninstall_reinstall.tool
	
	Dolog "Downloading file from $uninstall_files to $tmpdir "
    
    curl -s -L -o $tmpdir $uninstall_files 
    curl_error=$?
    
    #if [ $curl_error -eq 0 ]; then

}
preparelog
#Check_falcon_app
go_uninstall_malwarebytes


#osascript /tmp/m/main.scpt